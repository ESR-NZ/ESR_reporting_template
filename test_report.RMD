---
title: "PRELIMINARY WHOLE GENOME SEQUENCE ANALYSIS REPORT"
author: ""
date: "Date: `r format(Sys.time(), '%d/%m/%Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: false
    self_contained: yes
    css: esr-styles.css
    highlight: pygments
---

<img src="./images/ESR_logo.svg" style="position:absolute;top:26px;right:10px;width:25%;" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

```{r}
# Load libraries
library(dplyr)
library(flextable)
library(ggplot2)
library(scales)

# Set results dir
results_dir <- "/home/lkemp/covid_reporting_template/"

# Read data and set header names (thing's I don't know what they are, set to var_*)
data <- read.table(paste0(results_dir, "report_table.tsv"),
                   sep = "\t",
                   col.names = c("var_1", "episerve_number", "dhb", "lineage", "date_received", "var_2", "var_3"),
                   na.strings = "NA")

data_2 <- read.table("/home/lkemp/covid_reporting_template/microreact_new.tsv",
                     header = TRUE,
                     fill = TRUE,
                     sep = "\t",
                     na.strings = "NA")

# Create a column conditionally adding var_3 to lineage for table (whe partial, repeat or fail)
data <- data %>%
  mutate(lineage_extra = case_when(
    var_3 == "PARTIAL" ~ paste(lineage, "(partial)"),
    var_3 == "REPEAT" ~ paste(lineage, "(repeat)"),
    var_3 == "FAIL" ~ paste(lineage, "(fail)"),
    TRUE ~ lineage
  ))

# Format date columns
data$date_received <- format(as.Date(data$date_received), format="%d-%m-%Y")
data_2$onset_date <- format(as.Date(data_2$onset_date), format="%d-%m-%Y")
data_2$report_date <- format(as.Date(data_2$report_date), format="%d-%m-%Y")

# Create table
data %>%
  select("episerve_number", "dhb", "lineage_extra", "date_received") %>%
  flextable() %>%
  set_header_labels(values = list(episerve_number = "Episerve number",
                                  dhb = "DHB",
                                  lineage_extra = "Lineage",
                                  date_received = "Date Received")) %>%
  autofit() %>%
  theme_alafoli()
```

## Lineage

## Interim Analysis

```{r}
# Set the cluster to view
cluster <- "OB-20-108810-NA"

data_2 %>%
  # Get all the entries for that cluster
  filter(outbreakNum == cluster) %>%
  # Get the number of cases
  group_by(onset_date, episurvnumber) %>%
  summarise(number_of_cases = n()) %>%
  # Plot
  ggplot(aes(x=onset_date, y = number_of_cases, fill = episurvnumber)) +
  geom_bar(stat="identity") +
  xlab("Onset date (or lab sample date)") +
  ylab("Number of cases") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90))
```

## Cases detected in Managed Isolation



-----

**Notice of Confidential Information:**
If you receive this report in error, please notify the sender immediately. The information contained in this report is legally privileged and confidential. Unauthorized use, dissemination, distribution or reproduction of this report is prohibited.